<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title> COTIZACIONES PATO </title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f6fa;
  margin: 0; padding: 20px;
}
h1,h2,h3 { color: #2f3640; }
.container { max-width: 1200px; margin: auto; }
.section { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
input, select, button { margin: 5px 0; padding: 8px; font-size: 14px; }
button { cursor: pointer; background: #0984e3; color: #fff; border: none; border-radius: 5px; }
button:hover { background: #74b9ff; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #dcdde1; padding: 8px; text-align: center; }
th { background: #f1f2f6; }
.alert { color: red; font-weight: bold; }
</style>
</head>
<body>
<div class="container">
<h1>Cotizaciones</h1>

<!-- CLIENTES -->
<div class="section">
<h2>Clientes</h2>
<input type="text" id="erpClientName" placeholder="Nombre Cliente">
<input type="email" id="erpClientEmail" placeholder="Email Cliente">
<input type="text" id="erpClientRUC" placeholder="RUC/CÉDULA">
<input type="text" id="erpClientAddress" placeholder="Dirección">
<button onclick="createClientERP()">Crear Cliente</button>

<h3>Lista de Clientes</h3>
<table id="clientsTable">
<tr><th>ID</th><th>Nombre</th><th>Email</th><th>RUC</th><th>Dirección</th><th>Acciones</th></tr>
</table>
</div>

<!-- PRODUCTOS -->
<div class="section">
<h2>Productos</h2>
<input type="text" id="erpProductName" placeholder="Nombre Producto">
<input type="number" id="erpProductPrice" placeholder="Precio">
<input type="number" id="erpProductStock" placeholder="Stock">
<button onclick="createProductERP()">Crear Producto</button>

<h3>Lista de Productos</h3>
<table id="productsTable">
<tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr>
</table>
</div>

<!-- CARRITO -->
<div class="section">
<h2>Carrito / Cotizaciones</h2>
<select id="cartClientId"></select>
<select id="cartProductId"></select>
<input type="number" id="cartQuantity" placeholder="Cantidad">
<button onclick="addToCart()">Agregar al Carrito</button>

<h3>Carrito</h3>
<table id="cartTable">
<tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th>Acciones</th></tr>
</table>
<p>Total: $<span id="cartTotal">0.00</span></p>
<button onclick="createCartQuote()">Crear Cotización</button>

<h3>Cotizaciones</h3>
<table id="quotesTable">
<tr><th>ID</th><th>Cliente</th><th>Total</th><th>Acciones</th></tr>
</table>
</div>

<!-- FACTURAS -->
<div class="section">
<h2>Facturas</h2>
<table id="invoicesTable">
<tr><th>ID</th><th>Cliente</th><th>Total</th><th>Acciones</th></tr>
</table>
</div>
</div>

<!-- jsPDF para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Importar Firebase desde CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // Configuración de Firebase (TU PROYECTO)
  const firebaseConfig = {
    apiKey: "AIzaSyDSa5edzmz_yhvQni6lexhxNlUzc8AN3vA",
    authDomain: "mini-erp-bd0ba.firebaseapp.com",
    projectId: "mini-erp-bd0ba",
    storageBucket: "mini-erp-bd0ba.firebasestorage.app",
    messagingSenderId: "285846149373",
    appId: "1:285846149373:web:d71b7d71b917a966d50694"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Variables globales
  let clients = [];
  let products = [];
  let quotes = [];
  let invoices = [];
  let cartItems = [];
  let nextQuoteId = 1;
  let nextInvoiceId = 1;
  const IVA_RATE = 0.15;

  // === CLIENTES ===
  async function loadClients(){
    clients = [];
    const querySnapshot = await getDocs(collection(db, "clients"));
    querySnapshot.forEach(docSnap => {
      clients.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderClients();
  }

  async function createClientERP(){
    const name = document.getElementById('erpClientName').value.trim();
    const email = document.getElementById('erpClientEmail').value.trim();
    const ruc = document.getElementById('erpClientRUC').value.trim();
    const address = document.getElementById('erpClientAddress').value.trim();
    if(!name || !email){ alert("Nombre y Email requeridos"); return; }
    await addDoc(collection(db, "clients"), { name, email, ruc, address });
    loadClients();
  }

  function renderClients(){
    const table=document.getElementById('clientsTable');
    const cartClient = document.getElementById('cartClientId');
    table.innerHTML='<tr><th>ID</th><th>Nombre</th><th>Email</th><th>RUC</th><th>Dirección</th><th>Acciones</th></tr>';
    cartClient.innerHTML='';
    clients.forEach(c=>{
      const row=table.insertRow();
      row.insertCell(0).innerText=c.id;
      row.insertCell(1).innerText=c.name;
      row.insertCell(2).innerText=c.email;
      row.insertCell(3).innerText=c.ruc||'';
      row.insertCell(4).innerText=c.address||'';
      row.insertCell(5).innerHTML=`<button onclick="deleteClient('${c.id}')">Eliminar</button>`;
      const opt = document.createElement('option'); opt.value=c.id; opt.text=`${c.name}`; cartClient.add(opt);
    });
  }

  async function deleteClient(id){
    await deleteDoc(doc(db,"clients",id));
    loadClients();
  }

  // === PRODUCTOS ===
  async function loadProducts(){
    products = [];
    const querySnapshot = await getDocs(collection(db, "products"));
    querySnapshot.forEach(docSnap=>{
      products.push({id:docSnap.id, ...docSnap.data()});
    });
    renderProducts();
  }

  async function createProductERP(){
    const name=document.getElementById('erpProductName').value.trim();
    const price=parseFloat(document.getElementById('erpProductPrice').value)||0;
    const stock=parseInt(document.getElementById('erpProductStock').value)||0;
    if(!name){alert('Nombre requerido'); return;}
    await addDoc(collection(db,"products"),{name,price,stock});
    loadProducts();
  }

  function renderProducts(){
    const table=document.getElementById('productsTable');
    const cartProduct=document.getElementById('cartProductId');
    table.innerHTML='<tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr>';
    cartProduct.innerHTML='';
    products.forEach(p=>{
      const row=table.insertRow();
      row.insertCell(0).innerText=p.id;
      row.insertCell(1).innerText=p.name;
      row.insertCell(2).innerText=p.price.toFixed(2);
      row.insertCell(3).innerText=p.stock;
      row.insertCell(4).innerHTML=`<button onclick="deleteProduct('${p.id}')">Eliminar</button>`;
      const opt=document.createElement('option'); opt.value=p.id; opt.text=`${p.name}`; cartProduct.add(opt);
    });
  }

  async function deleteProduct(id){
    await deleteDoc(doc(db,"products",id));
    loadProducts();
  }

  // === CARRITO ===
  window.addToCart = function(){
    const clientId = document.getElementById('cartClientId').value;
    const productId = document.getElementById('cartProductId').value;
    const qty = parseInt(document.getElementById('cartQuantity').value);
    if(!clientId || !productId || !qty){ alert("Selecciona cliente, producto y cantidad"); return; }
    const product = products.find(p=>p.id===productId);
    if(!product || product.stock < qty){ alert("Stock insuficiente"); return; }
    const existing = cartItems.find(i=>i.productId===productId);
    if(existing){ existing.quantity += qty; } else { cartItems.push({productId, name:product.name, price:product.price, quantity:qty}); }
    updateCartTable();
  }

  function updateCartTable(){
    const table=document.getElementById('cartTable');
    table.innerHTML='<tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th>Acciones</th></tr>';
    let total=0;
    cartItems.forEach(i=>{
      const row=table.insertRow();
      row.insertCell(0).innerText=i.name;
      row.insertCell(1).innerText=i.quantity;
      row.insertCell(2).innerText=i.price.toFixed(2);
      row.insertCell(3).innerText=(i.quantity*i.price).toFixed(2);
      row.insertCell(4).innerHTML=`<button onclick="removeFromCart('${i.productId}')">X</button>`;
      total += i.quantity*i.price;
    });
    document.getElementById('cartTotal').innerText=total.toFixed(2);
  }

  window.removeFromCart = function(id){
    cartItems=cartItems.filter(i=>i.productId!==id);
    updateCartTable();
  }

  // === COTIZACIONES ===
  window.createCartQuote = function(){
    const clientId=document.getElementById('cartClientId').value;
    if(!clientId || cartItems.length===0){ alert("Selecciona cliente y agrega productos"); return; }
    const total=cartItems.reduce((s,i)=>s+i.price*i.quantity,0);
    quotes.push({id:nextQuoteId++, clientId, items:[...cartItems], total});
    cartItems=[]; updateCartTable(); renderQuotes();
  }

  function renderQuotes(){
    const table=document.getElementById('quotesTable');
    table.innerHTML='<tr><th>ID</th><th>Cliente</th><th>Total</th><th>Acciones</th></tr>';
    quotes.forEach(q=>{
      const c=clients.find(cl=>cl.id===q.clientId);
      const row=table.insertRow();
      row.insertCell(0).innerText=q.id;
      row.insertCell(1).innerText=c?c.name:q.clientId;
      row.insertCell(2).innerText=q.total.toFixed(2);
      row.insertCell(3).innerHTML=`<button onclick="convertQuoteToInvoice(${q.id})">Factura</button>
                                   <button onclick="deleteQuote(${q.id})">Eliminar</button>`;
    });
  }

  window.deleteQuote=function(id){ quotes=quotes.filter(q=>q.id!==id); renderQuotes(); }

  // === FACTURAS ===
  window.convertQuoteToInvoice=function(id){
    const q=quotes.find(x=>x.id===id); if(!q) return;
    const subtotal=q.total;
    const iva=subtotal*IVA_RATE;
    const total=subtotal+iva;
    const invoice={id:nextInvoiceId++, clientId:q.clientId, items:[...q.items], subtotal, iva, total};
    invoices.push(invoice);
    quotes=quotes.filter(x=>x.id!==id);
    renderInvoices(); renderQuotes();
  }

  function renderInvoices(){
    const table=document.getElementById('invoicesTable');
    table.innerHTML='<tr><th>ID</th><th>Cliente</th><th>Total</th><th>Acciones</th></tr>';
    invoices.forEach(inv=>{
      const c=clients.find(cl=>cl.id===inv.clientId);
      const row=table.insertRow();
      row.insertCell(0).innerText=inv.id;
      row.insertCell(1).innerText=c?c.name:inv.clientId;
      row.insertCell(2).innerText=inv.total.toFixed(2);
      row.insertCell(3).innerHTML=`<button onclick="downloadInvoicePDF(${inv.id})">PDF</button>`;
    });
  }

  // === PDF FACTURA ===
  window.downloadInvoicePDF=function(id){
    const { jsPDF }=window.jspdf;
    const inv=invoices.find(i=>i.id===id);
    const c=clients.find(cl=>cl.id===inv.clientId);
    if(!inv||!c) return;
    const doc=new jsPDF({unit:'pt',format:'a4'});
    let y=60;
    doc.setFillColor(9,132,227); doc.rect(0,0,595,80,'F');
    doc.setFontSize(20); doc.setTextColor(255,255,255); doc.text("Factura",40,50);
    doc.setFontSize(12); doc.text(`Fecha: ${new Date().toLocaleDateString()}`,400,50);
    y=100;
    doc.setTextColor(0,0,0);
    doc.text(`Factura ID: ${inv.id}`,40,y);
    doc.text(`Cliente: ${c.name}`,40,y+20);
    doc.text(`Email: ${c.email}`,40,y+40);
    y+=80;
    doc.text("Producto",45,y); doc.text("Cantidad",250,y); doc.text("Precio",350,y); doc.text("Subtotal",450,y);
    y+=20;
    inv.items.forEach(i=>{
      doc.text(i.name,45,y);
      doc.text(i.quantity.toString(),270,y);
      doc.text(`$${i.price}`,370,y);
      doc.text(`$${(i.price*i.quantity).toFixed(2)}`,470,y);
      y+=20;
    });
    y+=20;
    doc.text(`Subtotal: $${inv.subtotal.toFixed(2)}`,400,y); y+=20;
    doc.text(`IVA: $${inv.iva.toFixed(2)}`,400,y); y+=20;
    doc.setFontSize(14); doc.setTextColor(9,132,227);
    doc.text(`TOTAL: $${inv.total.toFixed(2)}`,400,y);
    doc.save(`Factura_${inv.id}.pdf`);
  }

  // Inicializar
  loadClients(); loadProducts();
</script>
</body>
</html>

